version: '3'

tasks:
  default: 
    cmds: 
    - task --list 

  up:
    desc: Runs all commands
    cmds:
    - task: extensions
    - task: targets
    - task: experiments

  extensions:
    desc: Installing Chaos Mesh via Helm
    cmds:
    - helm repo add chaos-mesh https://charts.chaos-mesh.org
    - helm repo update
    - kubectl create ns chaos-testing
    - helm install chaos-mesh chaos-mesh/chaos-mesh --namespace=chaos-testing --set chaosDaemon.runtime=containerd --set chaosDaemon.socketPath=/run/containerd/containerd.sock
    vars:
      AKS:
        sh: terraform -chdir=../infrastructure output -raw AKS_CLUSTER_NAME
      RG: 
        sh: az aks list --query "[?name=='{{.AKS}}']" | jq -r ".[].resourceGroup"

  targets:
    desc: On boards Chaos Extension onto AKS Cluster Resource
    cmds:
    - az group deployment create -n ChaosTargets -g {{.RG}} --template-file ./azurechaos.targets.json --parameters resourceName={{.AKS}} --parameters location={{.REGION}}
    vars:
      AKS:
        sh: terraform -chdir=../infrastructure output -raw AKS_CLUSTER_NAME
      RG: 
        sh:  terraform -chdir=../infrastructure output -raw AKS_RESOURCE_GROUP
      REGION:
        sh:  terraform -chdir=../infrastructure output -raw CHAOS_RESOURCE_LOCATION        

  experiments:
    desc: Creates an Chaos Engineering
    cmds:
    - az group deployment create -n ChaosExperiment -g {{.RG}} --template-file ./azurechaos.experiment.json --parameters aksClusterName={{.AKS}} --parameters aksClusterResourceGroup={{.AKS_RG}} 
    vars:
      AKS:
        sh: terraform -chdir=../infrastructure output -raw AKS_CLUSTER_NAME
      AKS_RG:
        sh: terraform -chdir=../infrastructure output -raw AKS_RESOURCE_GROUP
      RG: 
        sh:  terraform -chdir=../infrastructure output -raw CHAOS_RESOURCE_GROUP
